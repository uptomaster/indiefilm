rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // 헬퍼 함수: 로그인 확인
    function isSignedIn() {
      return request.auth != null;
    }
    
    // 헬퍼 함수: 본인 확인
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    // 헬퍼 함수: 역할 확인 (users 컬렉션에서 읽어옴)
    function hasRole(role) {
      return isSignedIn() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == role;
    }
    
    // users 컬렉션
    match /users/{userId} {
      // 읽기: 로그인한 사용자만
      allow read: if isSignedIn();
      // 생성: 본인만 (회원가입 시)
      allow create: if isOwner(userId);
      // 수정: 본인만
      allow update: if isOwner(userId);
      // 삭제: 불가 (안전을 위해)
      allow delete: if false;
    }
    
    // movies 컬렉션
    match /movies/{movieId} {
      // 읽기: 모든 사람 (공개)
      allow read: if true;
      // 생성: 제작자만
      allow create: if isSignedIn() && hasRole("filmmaker");
      // 수정: 본인이 만든 영화만
      allow update: if isSignedIn() && 
                       resource.data.filmmakerId == request.auth.uid;
      // 삭제: 본인이 만든 영화만
      allow delete: if isSignedIn() && 
                       resource.data.filmmakerId == request.auth.uid;
    }
    
    // actors 컬렉션
    match /actors/{actorId} {
      // 읽기: 공개된 프로필만 (isPublic == true) 또는 본인
      // 쿼리와 단일 문서 읽기 모두 지원
      allow read: if resource.data.isPublic == true || 
                     isOwner(actorId);
      // 생성: 배우 역할만, 본인 uid와 일치해야 함
      allow create: if isSignedIn() && 
                        hasRole("actor") && 
                        actorId == request.auth.uid;
      // 수정: 본인만
      allow update: if isOwner(actorId);
      // 삭제: 불가 (안전을 위해)
      allow delete: if false;
    }
    
    // requests 컬렉션 (캐스팅 요청/출연 희망)
    match /requests/{requestId} {
      // 읽기: 요청을 보낸 사람 또는 받은 사람만
      allow read: if isSignedIn() && 
                     (request.auth.uid == resource.data.fromUserId ||
                      request.auth.uid == resource.data.toUserId);
      // 생성: 로그인한 사용자만
      allow create: if isSignedIn() && 
                       request.resource.data.fromUserId == request.auth.uid;
      // 수정: 요청을 받은 사람만 (상태 변경: pending -> accepted/rejected)
      // 또는 요청을 받은 사람이 read 필드 업데이트 가능
      allow update: if isSignedIn() && 
                      request.auth.uid == resource.data.toUserId;
      // 삭제: 불가
      allow delete: if false;
      
      // messages 서브컬렉션 (채팅 메시지)
      match /messages/{messageId} {
        // 읽기: 메시지에 저장된 fromUserId 또는 toUserId와 일치하는 사용자만
        // 기존 메시지 호환성을 위해 부모 문서도 확인
        allow read: if isSignedIn() && 
                       ((resource.data.fromUserId != null && resource.data.toUserId != null &&
                         (resource.data.fromUserId == request.auth.uid || resource.data.toUserId == request.auth.uid)) ||
                        (get(/databases/$(database)/documents/requests/$(requestId)).data.fromUserId == request.auth.uid ||
                         get(/databases/$(database)/documents/requests/$(requestId)).data.toUserId == request.auth.uid));
        // 생성: 메시지의 userId가 현재 사용자와 일치하고, 부모 요청의 참여자여야 함
        // 메시지의 fromUserId/toUserId도 부모 요청과 일치해야 함
        allow create: if isSignedIn() && 
                         request.resource.data.userId == request.auth.uid &&
                         request.resource.data.fromUserId != null &&
                         request.resource.data.toUserId != null &&
                         (request.resource.data.fromUserId == request.auth.uid ||
                          request.resource.data.toUserId == request.auth.uid) &&
                         request.resource.data.fromUserId == get(/databases/$(database)/documents/requests/$(requestId)).data.fromUserId &&
                         request.resource.data.toUserId == get(/databases/$(database)/documents/requests/$(requestId)).data.toUserId;
        // 수정/삭제: 불가
        allow update: if false;
        allow delete: if false;
      }
    }
    
    // movieRatings 컬렉션 (영화 평점)
    match /movieRatings/{ratingId} {
      // 읽기: 로그인한 사용자는 모든 평점을 읽을 수 있음
      // 쿼리와 단일 문서 읽기 모두 지원
      // 쿼리에서는 resource가 없으므로 로그인만 확인
      // 단일 문서 읽기에서는 resource.data 확인 가능
      allow read: if isSignedIn();
      // 생성: 로그인한 사용자만, 본인 userId와 일치해야 함
      allow create: if isSignedIn() && 
                       request.resource.data.userId == request.auth.uid;
      // 수정: 본인이 작성한 평점만
      allow update: if isSignedIn() && 
                      resource.data.userId == request.auth.uid;
      // 삭제: 불가 (soft delete 사용)
      allow delete: if false;
    }
    
    // filmmakers 컬렉션 (제작자 프로필)
    match /filmmakers/{filmmakerId} {
      // 읽기: 공개된 프로필만 (isPublic == true) 또는 본인
      // 쿼리와 단일 문서 읽기 모두 지원
      allow read: if resource.data.isPublic == true || 
                     isOwner(filmmakerId);
      // 생성: 제작자 역할만, 본인 uid와 일치해야 함
      allow create: if isSignedIn() && 
                        hasRole("filmmaker") && 
                        filmmakerId == request.auth.uid;
      // 수정: 본인만
      allow update: if isOwner(filmmakerId);
      // 삭제: 불가 (안전을 위해)
      allow delete: if false;
    }
    
    // posts 컬렉션 (커뮤니티)
    match /posts/{postId} {
      // 읽기: 공개된 게시글만 또는 작성자
      // 쿼리와 단일 문서 읽기 모두 지원
      allow read: if resource == null || 
                     resource.data.isPublic == true || 
                     (isSignedIn() && resource.data.authorId == request.auth.uid);
      // 생성: 로그인한 사용자만, authorId가 현재 사용자와 일치해야 함
      allow create: if isSignedIn() && 
                       request.resource.data.authorId == request.auth.uid;
      // 수정: 작성자만
      allow update: if isSignedIn() && 
                      resource.data.authorId == request.auth.uid;
      // 삭제: 작성자만
      allow delete: if isSignedIn() && 
                      resource.data.authorId == request.auth.uid;
      
      // comments 서브컬렉션 (댓글)
      match /comments/{commentId} {
        // 읽기: 게시글이 공개되어 있거나 작성자
        allow read: if get(/databases/$(database)/documents/posts/$(postId)).data.isPublic == true ||
                       (isSignedIn() && get(/databases/$(database)/documents/posts/$(postId)).data.authorId == request.auth.uid);
        // 생성: 로그인한 사용자만
        allow create: if isSignedIn() && 
                         request.resource.data.userId == request.auth.uid;
        // 수정: 불가
        allow update: if false;
        // 삭제: 댓글 작성자만
        allow delete: if isSignedIn() && 
                        resource.data.userId == request.auth.uid;
      }
    }
  }
}
